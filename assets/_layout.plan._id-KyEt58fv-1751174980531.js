import{p as R,U as $,b as E,a as A,r as d,V as B,j as e}from"./index-zp2nMl9D-1751174980531.js";import{u as C}from"./index.esm-B4TPyIND-1751174980531.js";import{B as k}from"./button-Cqc4v3GU-1751174980531.js";import{C as m,a as x,b as p,d as h}from"./card-Dg8wDAoB-1751174980531.js";import{I as U}from"./input-BhTRTT4z-1751174980531.js";import{S as q}from"./separator-B_llpgAs-1751174980531.js";import{A as L,b as T}from"./alert-CApVxIxI-1751174980531.js";import{M as G}from"./markdown-C1PxgyY9-1751174980531.js";import{C as H}from"./credit-card-vtF1NXY5-1751174980531.js";import{C as V}from"./circle-check-big-DX17IEmj-1751174980531.js";import"./utils-BIJI3SUY-1751174980531.js";import"./index-BT14nGiI-1751174980531.js";import"./createLucideIcon-Ru6o5lSX-1751174980531.js";const z=u=>{const t=new URLSearchParams;return t.append("code",u.code),t.append("plan_id",u.plan_id),R.Post("/user/coupon/check",t.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})},J=[{key:"month_price",label:"月付",months:1},{key:"quarter_price",label:"季付",months:3},{key:"half_year_price",label:"半年付",months:6},{key:"year_price",label:"年付",months:12},{key:"two_year_price",label:"两年付",months:24},{key:"three_year_price",label:"三年付",months:36},{key:"onetime_price",label:"一次性",months:1},{key:"reset_price",label:"流量重置包",months:1}],ce=function(){const t=$.useLoaderData(),_=E(),{userInfo:y}=A(),[r,P]=d.useState({selectedPeriod:"",couponCode:""}),j=s=>P(i=>({...i,...s})),a=d.useMemo(()=>J.filter(s=>s.key==="reset_price"?y?.plan_id&&t[s.key]:t[s.key]).map(s=>({...s,price:t[s.key]})),[t,y?.plan_id]);d.useEffect(()=>{a.length&&!r.selectedPeriod&&j({selectedPeriod:a[0].key})},[a,r.selectedPeriod]);const g=d.useMemo(()=>a.find(s=>s.key===r.selectedPeriod),[a,r.selectedPeriod]),c=s=>(s/100).toFixed(2),f=s=>s.price/s.months,w=s=>{if(s.key==="onetime_price")return 0;const i=a.find(l=>l.key==="month_price");return i?Math.round((1-f(s)/f(i))*100):0},{send:S,loading:b,data:n}=C(s=>z(s),{immediate:!1}),{send:M,loading:N}=C(s=>B(s),{immediate:!1}).onSuccess(({data:s})=>{_({to:`/order/${s}`})}),o=g?.price??0,v=d.useMemo(()=>n?n.type===1?Math.max(0,o-n.value*100):o*(1-n.value/100):o,[n,o]),O=()=>{r.couponCode.trim()&&r.selectedPeriod&&S({code:r.couponCode,plan_id:t.id.toString()})},D=()=>{r.selectedPeriod&&M({period:r.selectedPeriod,plan_id:t.id,coupon_code:r.couponCode||void 0})};return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(m,{children:[e.jsx(x,{children:e.jsx(p,{className:"text-2xl",children:t.name})}),e.jsx(h,{children:e.jsx(G,{content:t.content})})]}),e.jsxs(m,{children:[e.jsx(x,{children:e.jsx(p,{children:"选择付款周期"})}),e.jsx(h,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:a.map(s=>{const i=r.selectedPeriod===s.key,l=w(s),F=f(s);return e.jsxs("div",{className:`relative cursor-pointer rounded-lg border-2 p-4 ${i?"border-primary bg-primary/10":"border-border hover:border-primary/50"}`,onClick:()=>j({selectedPeriod:s.key}),children:[l>0&&e.jsxs("div",{className:"absolute -top-1 -right-1 h-10 w-10 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-bold",children:["-",l,"%"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:`font-semibold ${i?"text-primary":""}`,children:s.label}),e.jsxs("div",{className:"flex justify-between items-end",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"¥"}),e.jsx("span",{className:`text-lg font-bold ${i?"text-primary":""}`,children:c(s.price)})]}),s.key!=="month_price"&&s.key!=="onetime_price"&&s.key!=="reset_price"&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["月均 ¥",c(F)]})]}),l>0&&e.jsxs("div",{className:"text-xs text-right",children:[e.jsx("div",{className:"text-muted-foreground",children:"节省"}),e.jsxs("div",{className:"text-green-600 font-semibold",children:["¥",c((a.find(I=>I.key==="month_price")?.price??0)*s.months-s.price)]})]})]})]})]},s.key)})})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(m,{children:[e.jsx(x,{children:e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5"}),"优惠券"]})}),e.jsxs(h,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(U,{placeholder:"输入优惠券代码",value:r.couponCode,onChange:s=>j({couponCode:s.target.value}),disabled:!r.selectedPeriod}),e.jsx(k,{onClick:O,disabled:!r.couponCode.trim()||b,children:b?"验证中...":"验证"})]}),n&&e.jsxs(L,{children:[e.jsx(V,{className:"h-4 w-4"}),e.jsxs(T,{children:[e.jsx("p",{className:"font-medium",children:n.name}),e.jsx("p",{className:"text-sm",children:n.type===1?`减免 ¥${n.value.toFixed(2)}`:`${n.value}% 折扣`})]})]})]})]}),e.jsxs(m,{children:[e.jsx(x,{children:e.jsx(p,{children:"订单详情"})}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-4 text-sm",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"套餐"}),e.jsx("span",{className:"font-medium",children:t.name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"周期"}),e.jsx("span",{className:"font-medium",children:g?.label})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"原价"}),e.jsxs("span",{children:["¥",c(o)]})]}),n&&e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsx("span",{children:"优惠"}),e.jsxs("span",{children:["-¥",c(o-v)]})]})]}),n&&e.jsx(q,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"总计"}),e.jsxs("span",{children:["¥",c(v)]})]}),e.jsx(k,{className:"w-full",onClick:D,disabled:N,children:N?"创建中...":"立即购买"})]})})]})]})]})};export{ce as component};
