import{m as R,T as $,b as E,a as A,r as d,U as B,j as e}from"./index-CpAe2TyT-986a79e.js";import{u as C}from"./index.esm-BjRxCemu-986a79e.js";import{B as k}from"./button-qitsshCf-986a79e.js";import{C as m,a as x,b as h,d as p}from"./card-D84RxqdL-986a79e.js";import{I as T}from"./input-Cu3ek2Fo-986a79e.js";import{S as U}from"./separator-CYoKvM2z-986a79e.js";import{A as q,b as L}from"./alert-0oHTHxrO-986a79e.js";import{M as G}from"./markdown-B5GUZBKe-986a79e.js";import{C as H}from"./credit-card-qxiDcWnx-986a79e.js";import{C as z}from"./circle-check-big-ge__r_jo-986a79e.js";import"./utils-hdC-wjgu-986a79e.js";import"./index-DoS_gqKE-986a79e.js";const J=u=>{const n=new URLSearchParams;return n.append("code",u.code),n.append("plan_id",u.plan_id),R.Post("/user/coupon/check",n.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})},K=[{key:"month_price",label:"月付",months:1},{key:"quarter_price",label:"季付",months:3},{key:"half_year_price",label:"半年付",months:6},{key:"year_price",label:"年付",months:12},{key:"two_year_price",label:"两年付",months:24},{key:"three_year_price",label:"三年付",months:36},{key:"onetime_price",label:"一次性",months:1},{key:"reset_price",label:"流量重置包",months:1}],ie=function(){const n=$.useLoaderData(),_=E(),{userInfo:y}=A(),[r,P]=d.useState({selectedPeriod:"",couponCode:""}),j=s=>P(i=>({...i,...s})),a=d.useMemo(()=>K.filter(s=>s.key==="reset_price"?y?.plan_id&&n[s.key]:n[s.key]).map(s=>({...s,price:n[s.key]})),[n,y?.plan_id]);d.useEffect(()=>{a.length&&!r.selectedPeriod&&j({selectedPeriod:a[0].key})},[a,r.selectedPeriod]);const g=d.useMemo(()=>a.find(s=>s.key===r.selectedPeriod),[a,r.selectedPeriod]),c=s=>(s/100).toFixed(2),f=s=>s.price/s.months,w=s=>{if(s.key==="onetime_price")return 0;const i=a.find(l=>l.key==="month_price");return i?Math.round((1-f(s)/f(i))*100):0},{send:S,loading:b,data:t}=C(s=>J(s),{immediate:!1}),{send:M,loading:N}=C(s=>B(s),{immediate:!1}).onSuccess(({data:s})=>{_({to:`/order/${s}`})}),o=g?.price??0,v=d.useMemo(()=>t?t.type===1?Math.max(0,o-t.value*100):o*(1-t.value/100):o,[t,o]),O=()=>{r.couponCode.trim()&&r.selectedPeriod&&S({code:r.couponCode,plan_id:n.id.toString()})},D=()=>{r.selectedPeriod&&M({period:r.selectedPeriod,plan_id:n.id,coupon_code:r.couponCode||void 0})};return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(m,{children:[e.jsx(x,{children:e.jsx(h,{className:"text-2xl",children:n.name})}),e.jsx(p,{children:e.jsx(G,{content:n.content})})]}),e.jsxs(m,{children:[e.jsx(x,{children:e.jsx(h,{children:"选择付款周期"})}),e.jsx(p,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:a.map(s=>{const i=r.selectedPeriod===s.key,l=w(s),F=f(s);return e.jsxs("div",{className:`relative cursor-pointer rounded-lg border-2 p-4 ${i?"border-primary bg-primary/10":"border-border hover:border-primary/50"}`,onClick:()=>j({selectedPeriod:s.key}),children:[l>0&&e.jsxs("div",{className:"absolute -top-1 -right-1 h-10 w-10 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-bold",children:["-",l,"%"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:`font-semibold ${i?"text-primary":""}`,children:s.label}),e.jsxs("div",{className:"flex justify-between items-end",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"¥"}),e.jsx("span",{className:`text-lg font-bold ${i?"text-primary":""}`,children:c(s.price)})]}),s.key!=="month_price"&&s.key!=="onetime_price"&&s.key!=="reset_price"&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["月均 ¥",c(F)]})]}),l>0&&e.jsxs("div",{className:"text-xs text-right",children:[e.jsx("div",{className:"text-muted-foreground",children:"节省"}),e.jsxs("div",{className:"text-green-600 font-semibold",children:["¥",c((a.find(I=>I.key==="month_price")?.price??0)*s.months-s.price)]})]})]})]})]},s.key)})})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(m,{children:[e.jsx(x,{children:e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5"}),"优惠券"]})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{placeholder:"输入优惠券代码",value:r.couponCode,onChange:s=>j({couponCode:s.target.value}),disabled:!r.selectedPeriod}),e.jsx(k,{onClick:O,disabled:!r.couponCode.trim()||b,children:b?"验证中...":"验证"})]}),t&&e.jsxs(q,{children:[e.jsx(z,{className:"h-4 w-4"}),e.jsxs(L,{children:[e.jsx("p",{className:"font-medium",children:t.name}),e.jsx("p",{className:"text-sm",children:t.type===1?`减免 ¥${t.value.toFixed(2)}`:`${t.value}% 折扣`})]})]})]})]}),e.jsxs(m,{children:[e.jsx(x,{children:e.jsx(h,{children:"订单详情"})}),e.jsx(p,{children:e.jsxs("div",{className:"space-y-4 text-sm",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"套餐"}),e.jsx("span",{className:"font-medium",children:n.name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"周期"}),e.jsx("span",{className:"font-medium",children:g?.label})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"原价"}),e.jsxs("span",{children:["¥",c(o)]})]}),t&&e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsx("span",{children:"优惠"}),e.jsxs("span",{children:["-¥",c(o-v)]})]})]}),t&&e.jsx(U,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"总计"}),e.jsxs("span",{children:["¥",c(v)]})]}),e.jsx(k,{className:"w-full",onClick:D,disabled:N,children:N?"创建中...":"立即购买"})]})})]})]})]})};export{ie as component};
